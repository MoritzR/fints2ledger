name: binaries-linux

on:
  push:
    branches: [ hs ]
  workflow_dispatch:


permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:

    - name: Check out
      uses: actions/checkout@v3

    - name: Cache ghcup-installed tools
      id:   ghcup
      uses: actions/cache@v3
      with:
        path: ~/.ghcup
        key: ${{ runner.os }}-ghcup-${{ hashFiles('**.yaml') }}
        restore-keys: |
             ${{ runner.os }}-ghcup

    - name: Cache cabal-installed libs
      id:   cabal
      uses: actions/cache@v3
      with:
        path: ~/.cabal
        key: ${{ runner.os }}-cabal-${{ hashFiles('**.yaml') }}
        restore-keys: |
             ${{ runner.os }}-cabal

    - name: Install ghc
      run: |
        ghcup install ghc --set 9.2.7

    - name: Install dependencies
      run: |
          ghc --version
          cabal --version
          cabal update
          cabal build --dependencies-only

    - name: Build and install artifact
      run: |
          export ARTIFACTS=linux/fints2ledger
          mkdir -p ${ARTIFACTS}
          cabal install --installdir="${ARTIFACTS}" --install-method=copy --enable-executable-static -fbundle_data_dir 
          strip "${ARTIFACTS}/fints2ledger"

    - uses: actions/upload-artifact@v3
      with:
        name: linux
        path: linux
